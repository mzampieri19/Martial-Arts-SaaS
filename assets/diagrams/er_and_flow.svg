<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="900" viewBox="0 0 1200 900">
  <style>
    .box { fill: #ffffff; stroke: #2b2b2b; stroke-width: 1.5; rx: 6px; }
    .title { font: bold 14px sans-serif; fill: #0b3954 }
    .col { font: 12px sans-serif; fill: #1f2d3d }
    .arrow { stroke: #0b3954; stroke-width: 1.2; fill: none; marker-end: url(#arrowhead); }
    .note { font: 12px sans-serif; fill: #2f5061 }
    .section-title { font: bold 16px sans-serif; fill: #0b3954 }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <path d="M0,0 L10,3.5 L0,7 z" fill="#0b3954" />
    </marker>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="3" result="shadow" />
      <feOffset in="shadow" dx="2" dy="2" />
      <feMerge>
        <feMergeNode />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>

  <!-- Title -->
  <text x="24" y="32" class="section-title">ER & Data Flow — Attendance, Goals, Masteries</text>

  <!-- Classes box -->
  <g transform="translate(40,70)">
    <rect class="box" width="240" height="120" />
    <text x="12" y="28" class="title">classes</text>
    <text x="12" y="52" class="col">• id (BIGINT) PK</text>
    <text x="12" y="68" class="col">• class_name</text>
    <text x="12" y="84" class="col">• difficulty, type_of_class</text>
    <text x="12" y="100" class="col">• target_sessions</text>
  </g>

  <!-- Attendance box -->
  <g transform="translate(320,70)">
    <rect class="box" width="320" height="160" />
    <text x="12" y="28" class="title">user_class_attendance</text>
    <text x="12" y="52" class="col">• id (UUID) PK</text>
    <text x="12" y="68" class="col">• user_id (UUID) FK → auth.users</text>
    <text x="12" y="84" class="col">• class_id (BIGINT) FK → classes.id</text>
    <text x="12" y="100" class="col">• attended_at (timestamptz)</text>
    <text x="12" y="116" class="col">• session_type, duration_minutes, notes</text>
    <text x="12" y="132" class="col"># raw event rows — app stores one per attended session</text>
  </g>

  <!-- class_goals box -->
  <g transform="translate(40,220)">
    <rect class="box" width="280" height="140" />
    <text x="12" y="28" class="title">class_goals</text>
    <text x="12" y="52" class="col">• id (BIGINT) PK</text>
    <text x="12" y="68" class="col">• class_id (BIGINT) FK → classes.id</text>
    <text x="12" y="84" class="col">• title, description</text>
    <text x="12" y="100" class="col">• required_sessions (int)</text>
    <text x="12" y="116" class="col">• sort_order</text>
  </g>

  <!-- user_goal_progress box -->
  <g transform="translate(360,260)">
    <rect class="box" width="300" height="120" />
    <text x="12" y="28" class="title">user_goal_progress</text>
    <text x="12" y="52" class="col">• id (UUID) PK</text>
    <text x="12" y="68" class="col">• user_id (UUID) FK → auth.users</text>
    <text x="12" y="84" class="col">• goal_id (BIGINT) FK → class_goals.id</text>
    <text x="12" y="100" class="col">• completed_at, notes</text>
  </g>

  <!-- masteries & mapping boxes -->
  <g transform="translate(40,400)">
    <rect class="box" width="240" height="90" />
    <text x="12" y="26" class="title">masteries</text>
    <text x="12" y="46" class="col">• id (BIGINT) PK</text>
    <text x="12" y="62" class="col">• title, description</text>
  </g>

  <g transform="translate(320,420)">
    <rect class="box" width="340" height="90" />
    <text x="12" y="26" class="title">mastery_goals</text>
    <text x="12" y="46" class="col">• id (BIGINT) PK</text>
    <text x="12" y="62" class="col">• mastery_id (FK → masteries.id)</text>
    <text x="12" y="78" class="col">• goal_id (FK → class_goals.id)</text>
  </g>

  <!-- server-side views box -->
  <g transform="translate(700,70)">
    <rect class="box" width="420" height="120" />
    <text x="12" y="28" class="title">server-side views & RPCs</text>
    <text x="12" y="52" class="col">• view_user_class_stats / get_user_class_stats(user_id)</text>
    <text x="12" y="68" class="col">  - returns attended_count, first/last dates, weeks_active, avg_per_week</text>
    <text x="12" y="84" class="col">• view_unique_class_goals</text>
    <text x="12" y="100" class="col">  - deduplicated goals per class (canonical title)</text>
  </g>

  <!-- UI box -->
  <g transform="translate(700,220)">
    <rect class="box" width="420" height="200" />
    <text x="12" y="28" class="title">Client — Track Progress page</text>
    <text x="12" y="52" class="col">• calls get_user_class_stats to load classes & class counts</text>
    <text x="12" y="68" class="col">• reads view_unique_class_goals for goals</text>
    <text x="12" y="84" class="col">• reads attendance rows for class and computes per-goal progress</text>
    <text x="12" y="100" class="col">• toggles user_goal_progress rows to mark goal complete</text>
    <text x="12" y="116" class="col">• shows contribution entries (date, class name, duration)</text>
    <text x="12" y="132" class="col">• optionally shows mastery status (when all goals complete)</text>
  </g>

  <!-- arrows: relationships -->
  <path class="arrow" d="M280 120 L320 120" />
  <path class="arrow" d="M200 190 L200 220" />
  <path class="arrow" d="M260 260 L320 300" />
  <!-- attendance -> stats/rpc -->
  <path class="arrow" d="M480 150 L700 150" />
  <!-- goals -> view_unique_class_goals (same table) -->
  <path class="arrow" d="M240 290 L700 100" />
  <!-- goals -> user progress -->
  <path class="arrow" d="M320 320 L360 300" />
  <!-- masteries -> mapping -->
  <path class="arrow" d="M160 460 L320 460" />
  <!-- client arrows -->
  <path class="arrow" d="M840 190 L760 150" />
  <path class="arrow" d="M760 300 L640 280" />

  <!-- notes under diagram -->
  <text x="24" y="740" class="note">Legend: arrows indicate foreign-key relationships or data flow (reads/calls).</text>
  <text x="24" y="760" class="note">Raw events: `user_class_attendance`. Goals: `class_goals`. User completions: `user_goal_progress`.</text>
  <text x="24" y="780" class="note">Views/RPC: server-side aggregations to speed client and avoid heavy joins in-app.</text>
  <text x="24" y="800" class="note">Exported: assets/diagrams/er_and_flow.svg</text>
</svg>
